# LLM 本文生成仕様

FastAPI + HTMX で動作する WP 下書き生成ツールの LLM 本文生成フローを定義する。出力本文は Markdown に統一し、HTML 変換はアプリ側で行う。将来のサイト追加やモデル切替に対応できるよう、差し替えポイントを明示する。

## パイプライン (Plan → Draft → QC → Revise)
- Plan: 入力ブリーフを基に構造化 `outline`、検索意図、禁止事項を整理し、`volatile_topics`（断定禁止の変わりうる情報）と `safe_assertions`（確定してよい事実）を明記した Plan JSON を作る。
- Draft: Plan の `outline` を順守し、H2 ごとに Markdown を段階生成する。全体を一気に生成しない。Plan で指定した `must_include`/`must_avoid` や `volatile_topics`/`safe_assertions` を遵守する。
- QC: JSON スキーマと機械判定ルールに基づき検査する。計測基準（文字数等）は後述の `quality_self_check` 定義に従う。不合格なら Revise へ。
- Revise: QC 指摘を踏まえ不足部分のみ再生成し、同じスキーマで再チェックする。

## JSON スキーマ（共通フィールド）
- `title`: 記事タイトル。
- `slug`: 英数字ハイフンのスラッグ。
- `meta_description`: メタディスクリプション（文字数目安は QC を参照）。
- `outline`: 構造化見出し配列。形式は後述。
- `markdown`: 本文（Markdown 固定）。`content_html` は廃止。
- `faq`: Q&A 配列。各要素 `{question, answer}`。
- `tags_suggestions`: WP タグ候補の配列。10 件以内。
- `volatile_topics`: 変わりうるため断定を避けるトピックの配列（Plan で必須、Draft 以降も持ち回り推奨）。
- `safe_assertions`: 確定的に述べてよい事実・前提の配列（Plan で必須）。
- `notes`: システム向け備考（使用モデル、再生成理由、懸念点など）。
- `quality_self_check`: Draft/Revise 段階での自己評価結果と計測値。

### outline スキーマ
```
outline: [
  {
    "id": "h2-1",
    "h2": "見出しタイトル",
    "intent": "この H2 で解決する読者の意図",
    "focus_keywords": ["主要キーワード", "..."],
    "must_include": ["必ず触れる論点", "..."],
    "must_avoid": ["避ける表現・禁則", "..."],
    "h3": [
      {"h3": "小見出し", "must_include": ["必須論点", "..."]},
      ...
    ]
  },
  ...
]
```

## 見出し単位生成と結合ルール
- Draft では H2 ごとに生成し、暴走や不整合を防ぐ。Plan の `id` 順に結合する。
- 各 H2 は独立して意味が通る 300 文字以上（英語なら 180 words 以上）を必須とする。H3 本文は 120 文字以上を推奨。
- Plan の `intent`/`focus_keywords` を外れた内容は書かない。`must_include` を漏らさず、`must_avoid` を入れない。
- H2/H3 タイトルは Markdown 見出しとしてそのまま出力し、順序や親子関係を `outline` と一致させる。
- `volatile_topics` は断定禁止、`safe_assertions` のみ断定可とし、それ以外は推測表現を用いる。

## QC の機械判定項目と再生成条件
- メタディス文字数: 全角 80–140 文字 (Unicode コードポイント数、前後空白除去後)。範囲外は再生成。
- 見出し数: H2 が 4–8 本。過不足は Plan から再生成。
- 本文量: 各 H2 配下の本文（Markdown テキストから見出し記号と改行を除いた文字列）で 300 文字以上。未満の H2 を再生成。
- H3 本文量: 120 文字未満の H3 がある場合は該当 H3 を再生成。
- 一貫性: `outline` の H2/H3 と `markdown` 中の見出しが一致しない場合は再生成。
- 事実根拠: `volatile_topics` に該当する事項を断定していないかを検出し、違反時は Revise。`safe_assertions` のみ断定を許容する。
- フォーマット: 必須フィールド欠落、空文字、JSON 不正は即時再生成。
- FAQ: 2–5 件。範囲外は再生成。
- タグ候補: 3–10 件、重複なし。範囲外は再生成。

## quality_self_check の計測基準
- `meta_description_length`: `meta_description` を前後空白除去し、Unicode コードポイントで数えた長さ。
- `markdown_length`: `markdown` 全体を Unicode コードポイントで数えた長さ（見出し記号や改行も含む）。
- `h2_count`: `outline` 内の H2 件数。
- `h3_count`: `outline` 全体の H3 件数。
- `min_h2_length`: 各 H2 配下本文（見出し行を除くテキスト）の最小文字数。Unicode コードポイントで計測。
- `min_h3_length`: 各 H3 配下本文の最小文字数。
- `faq_count`: `faq` 配列の件数。
- `assertive_language_found`: 断定表現が検出された場合に true。
- `regenerate_required`: QC で再生成が必要と判断した場合に true。

## 表現ガイドライン
- 変わりうる情報のみ断定禁止とし、`volatile_topics` に列挙する。確定情報は `safe_assertions` に明記して断定可とする。
- 法律・医療・金融などのクリティカル領域は一般情報に留め、専門家相談を促す一文を含める。
- 広告的誇張を避け、根拠なき絶対表現（「必ず」「絶対に」など）は使わない。
- 具体的な手順や設定値は、根拠や前提がない場合はレンジや例示として示す。
- 見出しと本文の主旨を一致させ、冗長な前置きよりも結論→理由→具体例の順を基本とする。

## SiteAdapter / PromptRenderer の差し替えポイント
- SiteAdapter: サイト固有要件（カテゴリ、デフォルトタグ、禁止ワード、ブランドトーン、`volatile_topics` テンプレ）をカプセル化し、Plan/Draft/QC の入力を調整する Strategy として実装する。サイト追加時は新しい Adapter を追加するだけで既存フローを変更しない。
- PromptRenderer: LLM へのプロンプト組み立てを Strategy 化し、モデルごとのフォーマット（JSON 指示の厳格さ、システムプロンプト長制御、見出し分割指示）を切り替え可能にする。SiteAdapter と組み合わせることでサイト × モデルの組合せを差し替えで対応。
- QC ルールも Adapter 側で上書きできるようにし、サイト別の文字数やトーン要件を設定可能にする。

## サンプル: 改訂スキーマに沿った記事 1 本分の JSON
```json
{
  "title": "クラウドバックアップの始め方ガイド",
  "slug": "cloud-backup-getting-started",
  "meta_description": "クラウドバックアップの仕組み、サービス選定の視点、初期設定の流れ、失敗しない運用のコツをまとめ、安全にデータを守る手順を解説します。実例ベースで初心者にも分かるチェックリスト付き。",
  "outline": [
    {
      "id": "h2-1",
      "h2": "クラウドバックアップとは",
      "intent": "概要と仕組みを理解させる",
      "focus_keywords": ["クラウドバックアップ", "仕組み"],
      "must_include": ["定義", "オンプレ比較"],
      "must_avoid": ["特定サービスの過度な推奨"],
      "h3": [
        {"h3": "仕組みと特徴", "must_include": ["冗長性", "自動化"] }
      ]
    },
    {
      "id": "h2-2",
      "h2": "サービス選定のポイント",
      "intent": "読者の用途別に選定基準を示す",
      "focus_keywords": ["サービス選定", "セキュリティ"],
      "must_include": ["価格帯", "暗号化", "リージョン"],
      "must_avoid": ["古い情報の断定"],
      "h3": [
        {"h3": "選定時の比較軸", "must_include": ["容量", "SLA"] }
      ]
    },
    {
      "id": "h2-3",
      "h2": "初期設定の流れ",
      "intent": "導入手順を段階的に示す",
      "focus_keywords": ["初期設定", "バックアップ計画"],
      "must_include": ["アカウント作成", "バックアップ先", "スケジュール"],
      "must_avoid": ["未検証の設定値断定"],
      "h3": [
        {"h3": "初期設定チェックリスト", "must_include": ["通知設定", "復元テスト"] }
      ]
    },
    {
      "id": "h2-4",
      "h2": "運用とトラブル防止のコツ",
      "intent": "安定運用のための注意点を示す",
      "focus_keywords": ["運用", "トラブルシュート"],
      "must_include": ["ログ確認", "バージョン履歴"],
      "must_avoid": ["誇張表現"],
      "h3": []
    },
    {
      "id": "h2-5",
      "h2": "まとめ",
      "intent": "要点を整理し次の行動を提示する",
      "focus_keywords": ["まとめ"],
      "must_include": ["再確認ポイント"],
      "must_avoid": ["新規情報の追加"],
      "h3": []
    }
  ],
  "markdown": "## クラウドバックアップとは\nこの段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。\n\n### 仕組みと特徴\nこのセクションはダミーテキストです。このセクションはダミーテキストです。このセクションはダミーテキストです。このセクションはダミーテキストです。このセクションはダミーテキストです。このセクションはダミーテキストです。\n\n## サービス選定のポイント\nこの段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。\n\n### 選定時の比較軸\nこのセクションはダミーテキストです。このセクションはダミーテキストです。このセクションはダミーテキストです。このセクションはダミーテキストです。このセクションはダミーテキストです。このセクションはダミーテキストです。\n\n## 初期設定の流れ\nこの段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。\n\n### 初期設定チェックリスト\nこのセクションはダミーテキストです。このセクションはダミーテキストです。このセクションはダミーテキストです。このセクションはダミーテキストです。このセクションはダミーテキストです。このセクションはダミーテキストです。\n\n## 運用とトラブル防止のコツ\nこの段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。\n\n## まとめ\nこの段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。この段落はダミーテキストです。",
  "faq": [
    {"question": "無料プランでも十分ですか？", "answer": "容量や履歴保持が限られるため、重要データには有料プランを検討してください。"},
    {"question": "転送速度が遅いときは？", "answer": "夜間にスケジュールする、回線の混雑を避ける、差分バックアップを使う方法があります。"}
  ],
  "tags_suggestions": ["クラウド", "バックアップ", "データ保護", "セキュリティ"],
  "volatile_topics": ["料金プランの最新価格", "特定サービスの提供可否", "リージョンの冗長構成の最新仕様"],
  "safe_assertions": ["バックアップは多重化で信頼性が上がる", "定期的な復元テストはリスク低減に有効"],
  "notes": "Draft v2。Plan で指定した volatile_topics を全て断定回避。各 H2/H3 に必須論点を反映済み。",
  "quality_self_check": {
    "meta_description_length": 90,
    "markdown_length": 1942,
    "h2_count": 5,
    "h3_count": 3,
    "min_h2_length": 300,
    "min_h3_length": 108,
    "faq_count": 2,
    "assertive_language_found": false,
    "regenerate_required": false
  }
}
```
